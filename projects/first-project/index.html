<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  1. Prepare Your Data
  #

Before diving into analysis, you need to prepare your images. Here’s what you need to get your data ready for processing:



  1.1 Stain the histological images of interest for CD31
  #

The first step is to obtain the histological images of interest. These images must include a stain that highlights blood vessels. Common choices are CD31 or CD34, both of which label the endothelial cells lining the vasculature. CD31 is particularly useful due to its strong and specific endothelial staining, while CD34 provides additional coverage of endothelial and progenitor cells. These stains are essential for enhancing vessel contrast and enabling analyses further down the pipeline. Finally, the slides need to be scanned digitally for further evaluation.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://spatialvesselanalysis.github.io/projects/first-project/">
  <meta property="og:site_name" content="Home">
  <meta property="og:title" content="Data Preparation">
  <meta property="og:description" content="1. Prepare Your Data # Before diving into analysis, you need to prepare your images. Here’s what you need to get your data ready for processing:
1.1 Stain the histological images of interest for CD31 # The first step is to obtain the histological images of interest. These images must include a stain that highlights blood vessels. Common choices are CD31 or CD34, both of which label the endothelial cells lining the vasculature. CD31 is particularly useful due to its strong and specific endothelial staining, while CD34 provides additional coverage of endothelial and progenitor cells. These stains are essential for enhancing vessel contrast and enabling analyses further down the pipeline. Finally, the slides need to be scanned digitally for further evaluation.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:published_time" content="2025-05-22T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-05-22T00:00:00+00:00">
<title>Data Preparation | Home</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://spatialvesselanalysis.github.io/projects/first-project/">
<link rel="stylesheet" href="/book.min.a7616cf2799b58bddffce9438e31fdbfc6393687cfc0950a4a17cd1cce7e35f6.css" integrity="sha256-p2Fs8nmbWL3f/OlDjjH9v8Y5NofPwJUKShfNHM5&#43;NfY=" crossorigin="anonymous"><!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '\\(', right: '\\)', display: false},
        {left: '$', right: '$', display: false}
      ]
    });">
  </script>



<link rel="stylesheet" href="/book.min.css">
<script defer src="/en.search.min.2b6333591953211fc501497937cbcdc6fcf29ad8ccca8f8e9dfa3e18bbb5848a.js"></script>
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Home</span>
  </a>
</h2>














  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/projects/" class="">Step-by-Step Guide</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/projects/first-project/" class="active">Data Preparation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/projects/second-project/" class="">Vessel Segmentation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/projects/third-project/" class="">Statistics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/projects/fourth-project/" class="">Drug Distribution</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/projects/fith-projct/" class="">Interpretation</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/about/" class="">About Us</a>
  

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Data Preparation</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#11-stain-the-histological-images-of-interest-for-cd31">1.1 Stain the histological images of interest for CD31</a></li>
    <li><a href="#12-ensure-the-images-are-formatted-correctly">1.2 Ensure the images are formatted correctly</a></li>
    <li><a href="#13-remove-image-artifacts">1.3 Remove image artifacts</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="1-prepare-your-data">
  1. Prepare Your Data
  <a class="anchor" href="#1-prepare-your-data">#</a>
</h1>
<p>Before diving into analysis, you need to prepare your images. Here’s what you need to get your data ready for processing:</p>
<ul>
<li>
<h2 id="11-stain-the-histological-images-of-interest-for-cd31">
  1.1 Stain the histological images of interest for CD31
  <a class="anchor" href="#11-stain-the-histological-images-of-interest-for-cd31">#</a>
</h2>
<p>The first step is to obtain the histological images of interest. These images must include a stain that highlights blood vessels. Common choices are CD31 or CD34, both of which label the endothelial cells lining the vasculature. CD31 is particularly useful due to its strong and specific endothelial staining, while CD34 provides additional coverage of endothelial and progenitor cells. These stains are essential for enhancing vessel contrast and enabling analyses further down the pipeline. Finally, the slides need to be scanned digitally for further evaluation.</p>
</li>
<li>
<h2 id="12-ensure-the-images-are-formatted-correctly">
  1.2 Ensure the images are formatted correctly
  <a class="anchor" href="#12-ensure-the-images-are-formatted-correctly">#</a>
</h2>
<p>Once you have your images, it’s crucial that they are in the right format for compatibility with the analysis pipeline. The most commonly used image formats for this type of work are <code>.tiff</code> (higher quality, slower processing) and <code>.jpg</code> (lower quality, faster processing).</p>
</li>
<li>
<h2 id="13-remove-image-artifacts">
  1.3 Remove image artifacts
  <a class="anchor" href="#13-remove-image-artifacts">#</a>
</h2>
<p>Unfortunately, microscope WSIs often suffer from artifacts. Being able to remove them is a crucial step to ensure that downstream analyses are not misled by irrelevant visual noise. The Python script <code>ArtifactRemover.py</code> (script downloadable from the user slrenne&rsquo;s erivessel repository) allows you to manually or automatically exclude artifacts from WSIs. It provides both a graphical interface and interactive image filtering options to clean up unwanted areas of tissue from further processing. You can choose between freehand cropping or automatic thresholding based on how many images you have: cropping is ideal for a few images where precision is needed, while automatic L-channel filtering is better suited for batch processing many slides quickly.</p>
<p>To begin, set up your environment by loading all necessary libraries. If they are not already downloaded to your computer, install them through the <code>pip</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib
</span></span><span style="display:flex;"><span>matplotlib<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;TkAgg&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> skimage <span style="color:#f92672">import</span> color
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> matplotlib.widgets <span style="color:#f92672">import</span> Slider
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tkinter <span style="color:#f92672">import</span> Tk, Button, filedialog, messagebox, Label
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tempfile
</span></span></code></pre></div><p>The class <code>WSIProcessor</code> encapsulates all functionality to load an image, crop it manually or filter it automatically, and save the output. It takes a single image path as input and stores both the original and processed versions of the image. It reads the image using OpenCV in BGR format and it converts it to RGB so it displays correctly with matplotlib and PIL.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WSIProcessor</span>:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> __init__(self, image_path):
</span></span><span style="display:flex;"><span>     self<span style="color:#f92672">.</span>image_path <span style="color:#f92672">=</span> image_path
</span></span><span style="display:flex;"><span>     self<span style="color:#f92672">.</span>original_image <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(image_path)
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>original_image <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">FileNotFoundError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Image not found: </span><span style="color:#e6db74">{</span>image_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>     self<span style="color:#f92672">.</span>image <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>cvtColor(self<span style="color:#f92672">.</span>original_image, cv2<span style="color:#f92672">.</span>COLOR_BGR2RGB)
</span></span><span style="display:flex;"><span>     self<span style="color:#f92672">.</span>cropped_image <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p>The function <code>show_image</code> displays any image in a blocking matplotlib window.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_image</span>(self, img, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Image&#39;</span>, cmap<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>imshow(img, cmap<span style="color:#f92672">=</span>cmap)
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>title(title)
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>show(block<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) 
</span></span></code></pre></div><p>The function <code>save_result</code> uses a file dialog to let you choose where to save the processed image. it converts the NumPy array to a PIL Image and saves it as default in <code>.png</code> format.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_result</span>(self, img):
</span></span><span style="display:flex;"><span>     save_path <span style="color:#f92672">=</span> filedialog<span style="color:#f92672">.</span>asksaveasfilename(
</span></span><span style="display:flex;"><span>         defaultextension<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.png&#34;</span>,
</span></span><span style="display:flex;"><span>         filetypes<span style="color:#f92672">=</span>[(<span style="color:#e6db74">&#34;PNG files&#34;</span>, <span style="color:#e6db74">&#34;*.png&#34;</span>), (<span style="color:#e6db74">&#34;All files&#34;</span>, <span style="color:#e6db74">&#34;*.*&#34;</span>)],
</span></span><span style="display:flex;"><span>         initialfile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;processed_image.png&#34;</span>
</span></span><span style="display:flex;"><span>     )
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> save_path:
</span></span><span style="display:flex;"><span>         Image<span style="color:#f92672">.</span>fromarray(img)<span style="color:#f92672">.</span>save(save_path)
</span></span><span style="display:flex;"><span>         messagebox<span style="color:#f92672">.</span>showinfo(<span style="color:#e6db74">&#34;Saved&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Image saved to:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>save_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>After the basic functions to open and save images, it&rsquo;s time to start processing your images. The <code>interactive_crop</code> function implements freehand region drawing using OpenCV&rsquo;s <code>cv2.setMouseCallback</code>. Here you draw points on the image(s) with your mouse to isolate the tissue areas you wish to keep and then press ENTER to finalize the outlined polygon from which a binary mask is created. The image is masked and pasted on a white background. The result is a cropped image that excludes any artifacts or unwanted areas from further processing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">interactive_crop</span>(self):
</span></span><span style="display:flex;"><span>     print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Draw freehand region on: </span><span style="color:#e6db74">{</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(self<span style="color:#f92672">.</span>image_path)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>     clone <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>image<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>     points <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw_polygon</span>(event, x, y, flags, param):
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> event <span style="color:#f92672">==</span> cv2<span style="color:#f92672">.</span>EVENT_LBUTTONDOWN:
</span></span><span style="display:flex;"><span>             points<span style="color:#f92672">.</span>append((x, y))
</span></span><span style="display:flex;"><span>             cv2<span style="color:#f92672">.</span>circle(clone, (x, y), <span style="color:#ae81ff">2</span>, (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>), <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">if</span> len(points) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                 cv2<span style="color:#f92672">.</span>line(clone, points[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>], points[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>             cv2<span style="color:#f92672">.</span>imshow(<span style="color:#e6db74">&#34;Draw Region&#34;</span>, clone)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     cv2<span style="color:#f92672">.</span>namedWindow(<span style="color:#e6db74">&#34;Draw Region&#34;</span>)
</span></span><span style="display:flex;"><span>     cv2<span style="color:#f92672">.</span>setMouseCallback(<span style="color:#e6db74">&#34;Draw Region&#34;</span>, draw_polygon)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>         cv2<span style="color:#f92672">.</span>imshow(<span style="color:#e6db74">&#34;Draw Region&#34;</span>, clone)
</span></span><span style="display:flex;"><span>         key <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>waitKey(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> <span style="color:#ae81ff">13</span>:  <span style="color:#75715e"># Enter</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">elif</span> key <span style="color:#f92672">==</span> <span style="color:#ae81ff">27</span>:  <span style="color:#75715e"># ESC</span>
</span></span><span style="display:flex;"><span>             cv2<span style="color:#f92672">.</span>destroyAllWindows()
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     cv2<span style="color:#f92672">.</span>destroyAllWindows()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> len(points) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>         mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(self<span style="color:#f92672">.</span>image<span style="color:#f92672">.</span>shape[:<span style="color:#ae81ff">2</span>], dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>         cv2<span style="color:#f92672">.</span>fillPoly(mask, [np<span style="color:#f92672">.</span>array(points)], <span style="color:#ae81ff">255</span>)
</span></span><span style="display:flex;"><span>         white_bg <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>full_like(self<span style="color:#f92672">.</span>image, <span style="color:#ae81ff">255</span>)
</span></span><span style="display:flex;"><span>         result <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(mask[:, :, <span style="color:#66d9ef">None</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span>, self<span style="color:#f92672">.</span>image, white_bg)
</span></span><span style="display:flex;"><span>         x, y, w, h <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>boundingRect(np<span style="color:#f92672">.</span>array(points))
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>cropped_image <span style="color:#f92672">=</span> result[y:y<span style="color:#f92672">+</span>h, x:x<span style="color:#f92672">+</span>w]
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>show_image(self<span style="color:#f92672">.</span>cropped_image, <span style="color:#e6db74">&#34;Cropped Image&#34;</span>)
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>save_result(self<span style="color:#f92672">.</span>cropped_image)
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>         print(<span style="color:#e6db74">&#34;Not enough points selected.&#34;</span>)
</span></span></code></pre></div><p>Here you convert the RGB image to Lab color space and extract only the L channel (lightness), which is useful for detecting e.g.folds in tissue. You are provided with a slider to interactively set a brightness threshold. Pixels below the threshold (i.e. folds) are removed and replaced with white. On window close, the current threshold is applied and the result is saved.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_l_channel</span>(self, img<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> img <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>         img <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>image
</span></span><span style="display:flex;"><span>     lab <span style="color:#f92672">=</span> color<span style="color:#f92672">.</span>rgb2lab(img)
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> lab[:, :, <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">interactive_L_threshold</span>(self):
</span></span><span style="display:flex;"><span>     L <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>extract_l_channel()
</span></span><span style="display:flex;"><span>     fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>subplots_adjust(bottom<span style="color:#f92672">=</span><span style="color:#ae81ff">0.25</span>)
</span></span><span style="display:flex;"><span>     ax<span style="color:#f92672">.</span>imshow(L, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gray&#39;</span>)
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;L Channel Thresholding&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     axthresh <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>axes([<span style="color:#ae81ff">0.25</span>, <span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.65</span>, <span style="color:#ae81ff">0.03</span>])
</span></span><span style="display:flex;"><span>     sthresh <span style="color:#f92672">=</span> Slider(axthresh, <span style="color:#e6db74">&#39;L threshold&#39;</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">100.0</span>, valinit<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(val):
</span></span><span style="display:flex;"><span>         threshold <span style="color:#f92672">=</span> sthresh<span style="color:#f92672">.</span>val
</span></span><span style="display:flex;"><span>         mask <span style="color:#f92672">=</span> L <span style="color:#f92672">&gt;</span> threshold
</span></span><span style="display:flex;"><span>         result <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(mask[:, :, <span style="color:#66d9ef">None</span>], self<span style="color:#f92672">.</span>image, <span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>         ax<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>         ax<span style="color:#f92672">.</span>imshow(result)
</span></span><span style="display:flex;"><span>         ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;Filtered Image&#39;</span>)
</span></span><span style="display:flex;"><span>         fig<span style="color:#f92672">.</span>canvas<span style="color:#f92672">.</span>draw_idle()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_close</span>(event):
</span></span><span style="display:flex;"><span>         threshold <span style="color:#f92672">=</span> sthresh<span style="color:#f92672">.</span>val
</span></span><span style="display:flex;"><span>         mask <span style="color:#f92672">=</span> L <span style="color:#f92672">&lt;</span> threshold
</span></span><span style="display:flex;"><span>         final_result <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(mask[:, :, <span style="color:#66d9ef">None</span>], self<span style="color:#f92672">.</span>image, <span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>         self<span style="color:#f92672">.</span>save_result(final_result)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     sthresh<span style="color:#f92672">.</span>on_changed(update)
</span></span><span style="display:flex;"><span>     fig<span style="color:#f92672">.</span>canvas<span style="color:#f92672">.</span>mpl_connect(<span style="color:#e6db74">&#39;close_event&#39;</span>, on_close)
</span></span><span style="display:flex;"><span>     plt<span style="color:#f92672">.</span>show(block<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p><code>process_images</code> opens a file dialog to let you select one or more images. For each selected image it creates a WSIProcessor instance and applies the chosen mode:</p>
<ul>
<li>&ldquo;crop&rdquo; → interactive_crop()</li>
<li>&ldquo;lchannel&rdquo; → interactive_L_threshold()</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># === GUI App ===</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_images</span>(mode):
</span></span><span style="display:flex;"><span>    file_paths <span style="color:#f92672">=</span> filedialog<span style="color:#f92672">.</span>askopenfilenames(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Select Image(s)&#34;</span>, filetypes<span style="color:#f92672">=</span>[(<span style="color:#e6db74">&#34;Image files&#34;</span>, <span style="color:#e6db74">&#34;*.jpg *.png *.jpeg *.tif *.tiff&#34;</span>)])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> file_paths:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> path <span style="color:#f92672">in</span> file_paths:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            processor <span style="color:#f92672">=</span> WSIProcessor(path)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;crop&#34;</span>:
</span></span><span style="display:flex;"><span>                processor<span style="color:#f92672">.</span>interactive_crop()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lchannel&#34;</span>:
</span></span><span style="display:flex;"><span>                processor<span style="color:#f92672">.</span>interactive_L_threshold()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            messagebox<span style="color:#f92672">.</span>showerror(<span style="color:#e6db74">&#34;Error&#34;</span>, str(e))
</span></span></code></pre></div><p><code>start_gui</code> creates a simple Tkinter window with two buttons, &ldquo;Manual Crop&rdquo; or &ldquo;L-Channel Filter&rdquo;, each launching <code>process_images()</code> in the selected mode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_gui</span>():
</span></span><span style="display:flex;"><span>    root <span style="color:#f92672">=</span> Tk()
</span></span><span style="display:flex;"><span>    root<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;WSI Artifact Removal Tool&#34;</span>)
</span></span><span style="display:flex;"><span>    root<span style="color:#f92672">.</span>geometry(<span style="color:#e6db74">&#34;400x200&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Label(root, text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Select Processing Mode&#34;</span>, font<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#34;Helvetica&#34;</span>, <span style="color:#ae81ff">14</span>))<span style="color:#f92672">.</span>pack(pady<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Button(root, text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Manual Crop&#34;</span>, command<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span>: process_images(<span style="color:#e6db74">&#34;crop&#34;</span>), width<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>, height<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>pack(pady<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>    Button(root, text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Automatic Filter&#34;</span>, command<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span>: process_images(<span style="color:#e6db74">&#34;lchannel&#34;</span>), width<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>, height<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>pack(pady<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    root<span style="color:#f92672">.</span>mainloop()
</span></span></code></pre></div><p>When the script is run, it immediately launches the GUI as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#python</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>     start_gui()
</span></span></code></pre></div><p>In summary, the execution flow is as follows.</p>
<ul>
<li>User selects a processing mode through a graphical user interface</li>
<li>User picks one or more images</li>
<li>The tool processes each image interactively</li>
<li>Images are saved</li>
</ul>
<p>Now, with freshly cleaned images, you&rsquo;re ready to move into the next stages of the workflow.</p>
</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#11-stain-the-histological-images-of-interest-for-cd31">1.1 Stain the histological images of interest for CD31</a></li>
    <li><a href="#12-ensure-the-images-are-formatted-correctly">1.2 Ensure the images are formatted correctly</a></li>
    <li><a href="#13-remove-image-artifacts">1.3 Remove image artifacts</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












